<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <script th:src="@{/script.js}"></script>
    <script th:src="@{/js/reportes.js}" defer></script>
</head>

<body>
    <main id='main-content' class="flex h-dvh">

        <!-- #region sidebar-->
        <div th:replace="~{fragments/sidebar.html :: sidebar-fragment}"></div>
        <!-- #endregion -->
        
        <div class="flex-1 h-screen overflow-y-scroll overflow-x-hidden">

            <div th:replace="~{fragments/header.html :: 
                              header-info('Reportes','Reportes del sistema')}"></div>
            
            <div class="container">

                <div th:replace="~{fragments/search.html :: search-fragment('reportes', 'Buscar reporte...')}"></div>

                <div class="filters-container">
                    <span class="filter-label">Filtrar por:</span>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Tipo:</label>
                            <select id="filtroTipo" onchange="Reportes.filtrarReportes()">
                                <option value="">Todos</option>
                                <option value="ventas">Ventas</option>
                                <option value="compras">Compras</option>
                                <option value="inventario">Inventario</option>
                                <option value="financiero">Financiero</option>
                                <option value="proveedores">Proveedores</option>
                                <option value="clientes">Clientes</option>
                                <option value="productos">Productos</option>
                                <option value="caja">Caja</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Estado:</label>
                            <select id="filtroEstado" onchange="Reportes.filtrarReportes()">
                                <option value="">Todos</option>
                                <option value="generado">Generado</option>
                                <option value="proceso">En Proceso</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <table id="tablaReportes">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre del Reporte</th>
                                <th>Tipo</th>
                                <th>Formato</th>
                                <th>Fecha Generaci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaReportes">
                            <!-- Reportes cargados din√°micamente -->
                            <tr th:each="reporte : ${reportes}" class="reporte-fila" 
                                th:data-tipo="${reporte.tipo}" th:data-estado="${reporte.estado}">
                                <td data-label="C√≥digo" th:text="${reporte.codigo}">RPT001</td>
                                <td data-label="Nombre del Reporte" th:text="${reporte.nombre}">Ventas Mensuales - Octubre 2025</td>
                                <td data-label="Tipo">
                                    <span th:class="${'tipo-' + reporte.tipo}">
                                        <span th:text="${#strings.capitalize(reporte.tipo)}">Ventas</span>
                                    </span>
                                </td>
                                <td data-label="Formato" th:text="${reporte.formato}">PDF</td>
                                <td data-label="Fecha Generaci√≥n" th:text="${#dates.format(reporte.fechaGeneracion, 'dd/MM/yyyy HH:mm')}">27/10/2025 08:30</td>
                                <td data-label="Estado">
                                    <span th:class="${'estado-' + reporte.estado}">
                                        <span th:text="${reporte.estado == 'generado' ? 'Generado' : (reporte.estado == 'proceso' ? 'En Proceso' : 'Error')}">
                                            Generado
                                        </span>
                                    </span>
                                </td>
                                <td data-label="Acciones">
                                    <div class="acciones-group">
                                        <a th:href="@{${reporte.urlAccion}}" th:if="${reporte.urlAccion != null}" 
                                           class="btn-ver">Ver</a>
                                        <button class="btn-editar" th:if="${reporte.estado == 'proceso'}"
                                                th:onclick="'Reportes.editarReporte(\'' + ${reporte.codigo} + '\')'">
                                            ‚úè Editar
                                        </button>
                                        <button class="btn-eliminar" 
                                                th:onclick="'Reportes.eliminarReporte(\'' + ${reporte.codigo} + '\')'">
                                            üóë Eliminar
                                        </button>
                                        <a th:href="@{/reportes/descargar/{codigo}(codigo=${reporte.codigo})}" 
                                           th:if="${reporte.estado == 'generado' && reporte.archivo != null}"
                                           class="btn-descargar">
                                            üì• Descargar
                                        </a>
                                        <a th:href="@{/ventas/reportes}" 
                                           th:if="${reporte.tipo == 'ventas' && reporte.estado == 'proceso'}"
                                           class="btn-continuar">
                                            ‚ûî Continuar Ventas
                                        </a>
                                        <a th:href="@{/compras/reportes}" 
                                           th:if="${reporte.tipo == 'compras' && reporte.estado == 'proceso'}"
                                           class="btn-continuar">
                                            ‚ûî Continuar Compras
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="estadisticas-reportes">
                    <div class="estadistica-item">
                        <span class="estadistica-numero" id="totalGenerados">0</span>
                        <span class="estadistica-label">Reportes Generados</span>
                    </div>
                    <div class="estadistica-item">
                        <span class="estadistica-numero" id="totalProceso">0</span>
                        <span class="estadistica-label">En Proceso</span>
                    </div>
                    <div class="estadistica-item">
                        <span class="estadistica-numero" id="totalErrores">0</span>
                        <span class="estadistica-label">Con Errores</span>
                    </div>
                </div>

                <div class="botones-contenedor">
                    <button class="btn-nuevo" onclick="Reportes.mostrarModalNuevoReporte()">
                        <span class="btn-icon">‚ûï</span>
                        Nuevo Reporte
                    </button>
                </div>

            </div>
        </div>

        <!-- Modal para nuevo reporte -->
        <div id="modalReporte" class="modal-reporte" style="display: none;">
            <div class="modal-reporte-contenido">
                <div class="modal-reporte-header">
                    <h2>Generar Reporte</h2>
                    <button class="modal-cerrar" onclick="Reportes.cerrarModalNuevoReporte()">&times;</button>
                </div>
                
                <!-- Formulario modificado -->
                <form th:action="@{/reportes/crear}" method="post" id="formNuevoReporte" class="modal-reporte-body">
                    <div class="form-grid">
                        <!-- Nombre del Reporte -->
                        <div class="form-group form-group-full">
                            <label for="nombreReporte">Nombre del Reporte *</label>
                            <input type="text" id="nombreReporte" class="form-input" name="nombre"
                                placeholder="Ej: Ventas Mensuales - Octubre 2025" required>
                        </div>

                        <!-- Tipo de Reporte -->
                        <div class="form-group">
                            <label for="tipoReporte">Tipo de Reporte *</label>
                            <select id="tipoReporte" class="form-select" name="tipo" required 
                                    onchange="Reportes.cambiarTipoReporte()">
                                <option value="">Seleccione...</option>
                                <option value="ventas">Ventas</option>
                                <option value="compras">Compras</option>
                                <option value="inventario">Inventario</option>
                                <option value="financiero">Financiero</option>
                                <option value="proveedores">Proveedores</option>
                                <option value="clientes">Clientes</option>
                                <option value="productos">Productos</option>
                                <option value="caja">Caja</option>
                            </select>
                        </div>

                        <!-- Formato de Salida -->
                        <div class="form-group">
                            <label for="formato">Formato de Salida *</label>
                            <select id="formato" class="form-select" name="formato" required>
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>

                        <!-- Per√≠odo -->
                        <div class="form-group">
                            <label for="periodo">Per√≠odo *</label>
                            <select id="periodo" class="form-select" name="periodo" 
                                    onchange="Reportes.cambiarPeriodo()" required>
                                <option value="personalizado">Personalizado</option>
                                <option value="hoy">Hoy</option>
                                <option value="ayer">Ayer</option>
                                <option value="semana-actual">Semana Actual</option>
                                <option value="mes-actual">Mes Actual</option>
                                <option value="trimestre">Trimestre</option>
                                <option value="anio">A√±o</option>
                            </select>
                        </div>

                        <!-- Estado -->
                        <div class="form-group">
                            <label for="estado">Estado Inicial *</label>
                            <select id="estado" class="form-select" name="estado" required>
                                <option value="proceso">En Proceso</option>
                                <option value="programado">Programado</option>
                            </select>
                        </div>

                        <!-- Fecha Desde -->
                        <div class="form-group">
                            <label for="fechaDesde">Fecha Desde *</label>
                            <input type="date" id="fechaDesde" class="form-input" name="fechaDesde" required>
                        </div>

                        <!-- Fecha Hasta -->
                        <div class="form-group">
                            <label for="fechaHasta">Fecha Hasta *</label>
                            <input type="date" id="fechaHasta" class="form-input" name="fechaHasta" required>
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="form-group form-group-full">
                            <label for="descripcion">Descripci√≥n (Opcional)</label>
                            <textarea id="descripcion" class="form-textarea" name="descripcion" rows="3"
                                placeholder="Agregue una descripci√≥n breve del reporte..."></textarea>
                        </div>
                    </div>

                    <div class="modal-reporte-footer">
                        <div class="footer-buttons">
                            <button type="button" class="btn-cancelar"
                                onclick="Reportes.cerrarModalNuevoReporte()">Cancelar</button>
                            <!-- Bot√≥n modificado -->
                            <button type="button" class="btn-registrar" id="btnGenerarReporte" onclick="Reportes.generarReporte()">
                                Generar Reporte
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de confirmaci√≥n -->
        <div id="modalConfirmacion" class="modal-confirmacion" style="display: none;">
            <div class="modal-confirmacion-contenido">
                <div class="modal-confirmacion-header">
                    <h3>Confirmar acci√≥n</h3>
                </div>
                <div class="modal-confirmacion-body">
                    <p id="mensajeConfirmacion"></p>
                </div>
                <div class="modal-confirmacion-footer">
                    <button type="button" class="btn-cancelar" onclick="Reportes.cerrarModalConfirmacion()">Cancelar</button>
                    <button type="button" class="btn-eliminar" id="btnConfirmarAccion">Confirmar</button>
                </div>
            </div>
        </div>
    </main>
</body>
</html>