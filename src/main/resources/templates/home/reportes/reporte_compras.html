<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/compras.css}">
    <link rel="stylesheet" th:href="@{/css/reporte_compras.css}">
    <script th:src="@{/script.js}"></script>
    <script th:src="@{/js/reporte_compras.js}" defer></script>
</head>

<body>
    <main id='main-content' class="flex h-dvh">
        <!-- #region sidebar-->
        <div th:replace="~{fragments/sidebar.html :: sidebar-fragment}"></div>
        <!-- #endregion -->
        
        <div class="flex-1 h-screen overflow-y-scroll overflow-x-hidden">
            <!-- #region header-->
            <div th:replace="~{fragments/header.html :: 
                          header-info('Reportes de Compras','Generar reportes detallados de compras')}"></div>
            <!-- #endregion -->

            <div class="container p-4 md:p-6">
                <!-- Sección: Información del reporte desde modal -->
                <div th:if="${fromModal}" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-800">
                                <span th:text="${nombre != null ? nombre : 'Reporte de Compras'}">Reporte de Compras</span>
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">
                                Configura los filtros específicos para personalizar tu reporte
                            </p>
                        </div>
                        <button onclick="ReporteCompras.cancelarReporte()" 
                                class="text-sm text-red-600 hover:text-red-800 font-medium">
                            Cancelar reporte
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Tipo:</span>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                <span th:text="${tipo != null ? #strings.capitalize(tipo) : 'Compras'}">Compras</span>
                            </span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Formato:</span>
                            <span class="ml-2" th:text="${formato != null ? formato : 'PDF'}">PDF</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Período:</span>
                            <span class="ml-2" th:text="${periodo != null ? periodo : 'Personalizado'}">Personalizado</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Estado:</span>
                            <span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">
                                <span th:text="${estado != null ? estado : 'En Proceso'}">En Proceso</span>
                            </span>
                        </div>
                    </div>
                    
                    <div th:if="${descripcion != null && !descripcion.isEmpty()}" class="mt-3 pt-3 border-t border-blue-200">
                        <span class="font-medium text-gray-600">Descripción:</span>
                        <p class="text-gray-700 mt-1" th:text="${descripcion}"></p>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-blue-200">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">Fecha desde:</span>
                                <span class="ml-2" th:text="${fechaDesde != null ? #temporals.format(#temporals.create(fechaDesde), 'dd/MM/yyyy') : 'No especificado'}">
                                    01/10/2025
                                </span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Fecha hasta:</span>
                                <span class="ml-2" th:text="${fechaHasta != null ? #temporals.format(#temporals.create(fechaHasta), 'dd/MM/yyyy') : 'No especificado'}">
                                    31/10/2025
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <form th:action="@{/compras/reportes/generar}" method="post" id="filtroForm">
                    <!-- Campos ocultos para los datos del modal -->
                    <input type="hidden" name="nombreReporte" th:value="${nombre != null ? nombre : 'Reporte de Compras'}">
                    <input type="hidden" name="tipoReporte" th:value="${tipo != null ? tipo : 'compras'}">
                    <input type="hidden" name="formato" th:value="${formato != null ? formato : 'pdf'}">
                    <input type="hidden" name="descripcion" th:value="${descripcion != null ? descripcion : ''}">
                    
                    <!-- Sección: Filtrar períodos -->
                    <div class="reporte-section">
                        <h2 class="reporte-title">Filtrar períodos</h2>
                        
                        <div class="filtro-grid">
                            <div class="filtro-group">
                                <label class="filtro-label">Fecha inicio *</label>
                                <div class="flex gap-2">
                                    <input type="date" class="filtro-input" name="fechaInicio" 
                                           th:value="${fechaDesde != null ? fechaDesde : fechaInicio}" 
                                           required>
                                    <input type="time" class="filtro-input w-32" name="horaInicio" 
                                           th:value="${horaInicio != null ? horaInicio : '00:00'}">
                                </div>
                            </div>
                            
                            <div class="filtro-group">
                                <label class="filtro-label">N° de factura</label>
                                <input type="text" class="filtro-input" name="numeroFactura" 
                                       th:value="${numeroFactura}" placeholder="Ej: 8888888">
                            </div>
                            
                            <div class="filtro-group">
                                <label class="filtro-label">Fecha fin *</label>
                                <div class="flex gap-2">
                                    <input type="date" class="filtro-input" name="fechaFin" 
                                           th:value="${fechaHasta != null ? fechaHasta : fechaFin}" 
                                           required>
                                    <input type="time" class="filtro-input w-32" name="horaFin" 
                                           th:value="${horaFin != null ? horaFin : '23:59'}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Filtrar proveedores -->
                    <div class="reporte-section">
                        <h2 class="reporte-title">Filtrar proveedores</h2>
                        
                        <div class="filtro-grid">
                            <div class="filtro-group">
                                <label class="filtro-label">RUC proveedor</label>
                                <input type="text" class="filtro-input" name="rucProveedor" 
                                       th:value="${rucProveedor}" placeholder="Ingrese RUC">
                            </div>
                            
                            <div class="filtro-group">
                                <label class="filtro-label">Nombre o razón social</label>
                                <input type="text" class="filtro-input" name="razonSocial" 
                                       th:value="${razonSocial}" 
                                       placeholder="Ej: Mespiu Cobreza Romona">
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Filtros de compras -->
                    <div class="reporte-section">
                        <h2 class="reporte-title">Filtros de compras</h2>
                        
                        <table class="filtro-tabla">
                            <thead>
                                <tr>
                                    <th>Tipo de pago:</th>
                                    <th>Total máximo (S/):</th>
                                    <th>Ordenar por:</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="radio-group">
                                            <div class="radio-option">
                                                <input type="checkbox" id="tipo-contado" name="tipoContado" 
                                                       th:checked="${tipoContado != null ? tipoContado : 'true'}">
                                                <label for="tipo-contado">Contado</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="checkbox" id="tipo-credito" name="tipoCredito"
                                                       th:checked="${tipoCredito != null ? tipoCredito : 'true'}">
                                                <label for="tipo-credito">Crédito</label>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" class="filtro-input" name="totalMaximo" 
                                               th:value="${totalMaximo}" placeholder="1000.00" step="0.01" min="0">
                                    </td>
                                    <td>
                                        <select class="filtro-input" name="ordenarPor">
                                            <option value="fecha" th:selected="${ordenarPor == 'fecha'}">Fecha</option>
                                            <option value="codigo" th:selected="${ordenarPor == 'codigo'}">Código</option>
                                            <option value="total" th:selected="${ordenarPor == 'total'}">Total</option>
                                            <option value="proveedor" th:selected="${ordenarPor == 'proveedor'}">Proveedor</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn-eliminar-filtros" onclick="ReporteCompras.eliminarFiltros()">
                                            Eliminar filtros
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label>Estado de compra:</label>
                                        <select class="filtro-input mt-1" name="estadoCompra">
                                            <option value="todos" th:selected="${estadoCompraSeleccionado == 'todos'}">Todos</option>
                                            <option value="PAGADO" th:selected="${estadoCompraSeleccionado == 'PAGADO'}">Pagado</option>
                                            <option value="PENDIENTE" th:selected="${estadoCompraSeleccionado == 'PENDIENTE'}">Pendiente</option>
                                            <option value="ANULADO" th:selected="${estadoCompraSeleccionado == 'ANULADO'}">Anulado</option>
                                        </select>
                                    </td>
                                    <td>
                                        <label>Total mínimo (S/):</label>
                                        <input type="number" class="filtro-input mt-1" name="totalMinimo" 
                                               th:value="${totalMinimo}" placeholder="10.00" step="0.01" min="0">
                                    </td>
                                    <td>
                                        <label>Orden:</label>
                                        <select class="filtro-input mt-1" name="orden">
                                            <option value="desc" th:selected="${orden == 'desc'}">Descendente</option>
                                            <option value="asc" th:selected="${orden == 'asc'}">Ascendente</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn-filtro" onclick="ReporteCompras.aplicarFiltros()">
                                            Aplicar filtros
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>

                <!-- Sección: Registros filtrados -->
                <div class="reporte-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="reporte-title">Registros filtrados</h2>
                        <div class="flex items-center gap-4">
                            <div class="text-sm font-semibold text-purple-700">
                                Total: <span id="totalRegistros" th:text="${compras != null ? compras.size() : 0}">0</span> registros
                            </div>
                            <button type="button" onclick="ReporteCompras.exportarDatos()" 
                                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                 Exportar datos
                            </button>
                        </div>
                    </div>
                    
                    <div class="reporte-table-container">
                        <table class="reporte-table" id="tablaCompras">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Proveedor</th>
                                    <th>RUC</th>
                                    <th>Deuda (S/.)</th>
                                    <th>Tipo de Pago</th>
                                    <th>Total (S/.)</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="compra : ${compras}" th:if="${compras != null && compras.size() > 0}">
                                    <td th:text="${compra.numeroFactura}">233</td>
                                    <td th:text="${compra.proveedor != null ? compra.proveedor.razonSocial : '---'}">
                                        Celso
                                    </td>
                                    <td th:text="${compra.proveedor != null ? compra.proveedor.ruc : '---'}">
                                        1037483733
                                    </td>
                                    <td th:text="${compra.saldoPendiente != null ? #numbers.formatDecimal(compra.saldoPendiente, 0, 2) : '0.00'}">
                                        0.00
                                    </td>
                                    <td>
                                        <span th:classappend="${compra.tipoCompra != null && compra.tipoCompra.name() == 'CREDITO'} ? 'tipo-credito' : 'tipo-contado'"
                                              th:text="${compra.tipoCompra != null ? compra.tipoCompra.name() : '---'}">
                                            Contado
                                        </span>
                                    </td>
                                    <td th:text="${compra.total != null ? #numbers.formatDecimal(compra.total, 0, 2) : '0.00'}">
                                        1200.00
                                    </td>
                                    <td>
                                        <span th:classappend="${compra.estadoPago != null && compra.estadoPago.name() == 'PAGADO'} ? 'estado-pagado' : 
                                                               (compra.estadoPago != null && compra.estadoPago.name() == 'PENDIENTE') ? 'estado-pendiente' : 
                                                               'estado-anulado'}"
                                              th:text="${compra.estadoPago != null ? compra.estadoPago.name() : 
                                                       (compra.estado != null ? compra.estado : '---')}">
                                            Pagado
                                        </span>
                                    </td>
                                    <td th:text="${compra.fechaFactura != null ? #temporals.format(compra.fechaFactura, 'dd/MM/yyyy') : '---'}">
                                        09/10/2025
                                    </td>
                                    <td th:text="${compra.fechaFactura != null ? #temporals.format(compra.fechaFactura, 'HH:mm') : '---'}">
                                        12:40
                                    </td>
                                </tr>
                                <tr th:if="${compras == null || compras.size() == 0}">
                                    <td colspan="9" class="text-center py-8 text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <p class="text-lg font-medium text-gray-600 mb-1">No se encontraron compras</p>
                                            <p class="text-gray-500">Ajusta los filtros o selecciona otro período</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600">
                            Mostrando <span class="font-semibold" th:text="${compras != null ? compras.size() : 0}">0</span> registros
                        </div>
                        <div class="flex gap-2">
                            <!-- Información de paginación -->
                            <span class="text-sm text-gray-600">
                                Página 1 de 1
                            </span>
                        </div>
                    </div>
                    
                    <!-- Resumen de totales - CORREGIDO -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">Total General</p>
                            <p class="text-xl font-bold text-blue-600">
                                S/. <span th:text="${totalGeneral != null ? #numbers.formatDecimal(totalGeneral, 0, 2) : '0.00'}">
                                    0.00
                                </span>
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">Total Pendiente</p>
                            <p class="text-xl font-bold text-yellow-600">
                                S/. <span th:text="${totalPendiente != null ? #numbers.formatDecimal(totalPendiente, 0, 2) : '0.00'}">
                                    0.00
                                </span>
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">Total Pagado</p>
                            <p class="text-xl font-bold text-green-600">
                                S/. <span th:text="${totalPagado != null ? #numbers.formatDecimal(totalPagado, 0, 2) : '0.00'}">
                                    0.00
                                </span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="botones-accion">
                    <button type="button" class="btn-reporte btn-cancelar" onclick="ReporteCompras.cancelarReporte()">
                        Cancelar
                    </button>
                    <button type="button" class="btn-reporte btn-generar" onclick="ReporteCompras.generarReporte()">
                        <span id="btnGenerarTexto">Generar Reporte</span>
                        <span id="btnGenerarLoading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </main>
</body>
</html>